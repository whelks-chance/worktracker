
<style>
    .person_details_outer {
        background-color: honeydew;
        padding: 1em;
        margin: 1em;
    }

    .person_details_inner {
        background-color: aliceblue;
    }

    .project_outline {
        background-color: beige;
    }

    .project_persons {
        padding-left: 4em;
    }

    .project_person {
        padding-left: 4em;
    }

    .project_tasks {
        background-color: lavender;
        padding-left: 4em;
    }

    .project_task {
        padding-left: 4em;
    }

    .task_people {
        padding-left: 4em;
    }

    .task_preceding_tasks {
        background-color: lavenderblush;
        padding-left: 4em;
    }
</style>


<script src="https://code.jquery.com/jquery-3.2.1.js"
        integrity="sha256-DZAnKJ/6XZ9si04Hgrsxu/8s717jcIzLy3oi35EouyE="
        crossorigin="anonymous"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.20.1/moment.js" integrity="sha256-2/3+Q1kMYR8MDaqFPNBgmLgiqWJjySkg1wqLx/iE5Zo=" crossorigin="anonymous"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.20.1/locale/uk.js" integrity="sha256-vdBxOXCFJ8UqQyiJrWLlnT1O/Bnvmpn+yrVrOg0Xafw=" crossorigin="anonymous"></script>

<script>
    $( document ).ready(function() {

        $.ajax({
            method: "GET",
            url: "{% url 'all_people_data' %}"
        })
            .done(function( msg ) {
{#                alert( "Data Saved: " + msg );#}
{#                $('#person_details_calc_1').text(JSON.stringify(msg, null, 2));#}

                for(var a in msg['people_data']) {
                    var data = msg['people_data'][a];
                    {#                    $('#person_details_calc_' + data['id']).text(data['count']);#}


{#                    var start = new moment(data['start_date']);#}
                    var end = new moment(data['end_date']);

                    {#                alert(end.diff(start, 'week') * data['hours_per_week']);#}
                    var num_weeks = end.diff(moment(), 'week');
                    var num_total_hours = num_weeks * data['hours_per_week'];
                    var left_available = num_total_hours - data['count'];
                    var perc_busy = data['count'] / num_total_hours * 100;

                    var bad_news_msg = "has " + num_weeks + " weeks left, with " + data['count'] + " hours spoken for." +
                        " This leaves them " + left_available + " hours. They are " + perc_busy + "% busy";

                    $('#person_details_calc_' + data['id']).text(bad_news_msg);
                }

            });
    });
</script>

<h3>There are {{ people|length }} people registered in the WorkTracker (tm)</h3>

{% for person in people %}
    <div class="person_details_outer" id="person_details_{{ person.id }}">
        <p>{{ person.name }}</p>
        <div class="person_details_inner" id="person_details_calc_{{ person.id }}">
        </div>
    </div>
{% endfor %}


{% for p in projects %}

    <div class="project_outline">
        <p>Project {{ forloop.counter }} of {{ projects|length }}</p>
        <h2>{{ p.name }}</h2>

        <p>
            {% if p.start_date %}
                The project started at {{ p.start_date }}.
            {% else %}
                The project has no recorded start date.
            {% endif %}
        </p>

        <p>
            {% if p.end_date %}
                The project is due to finish at {{ p.end_date }}.
            {% else %}
                The project will probably last forever.
            {% endif %}
        </p>

        <div class="project_persons">
            <h3>Project has {{ p.person_set.all|length }} workers assigned.</h3>
            <div class="project_person">
                {% for person in p.person_set.all %}
                    <p>{{ person.name }} is assigned:

                    {% for project_person_time in p.projecttimeassignment_set.all %}
                        {% if project_person_time.person == person %}
                            {{ project_person_time.hours }} hours
                            {% if project_person_time.financed %}
                                <strong>funded.</strong>
                            {% else %}
                                <strong>for free.</strong>
                            {% endif %}
                        {% endif %}
                    {% endfor %}
                {% endfor %}
                </p>
            </div>

            <div class="project_person_time">
                {% for project_person_time in p.projecttimeassignment_set.all %}
                    <p>{{ project_person_time.hours }} hours are assigned</p>
                {% endfor %}
            </div>
        </div>

        <div class="project_tasks">
            <h3>Project has {{ p.task_set.all|length }} tasks.</h3>
            <div class="project_task">

                {% for task in p.task_set.all %}
                    <h4>{{ task.name }}</h4>
                    <p>Task begins {{ task.start_date }} and ends {{ task.end_date }}</p>

                    <p>{{ task.people_assigned.all|length }} people_assigned</p>

                    {% for taskpeople in task.people_assigned.all %}
                        <div class="task_people">
                            <p>{{ taskpeople.name }} is assigned to this task.</p>
                        </div>
                    {% endfor %}

                    {% for preceding_task in task.preceding_tasks.all %}
                        <div class="task_preceding_tasks">
                            <p><strong>{{ preceding_task.name }}</strong> must complete before this task begins.</p>
                        </div>
                    {% endfor %}

                {% endfor %}
            </div>
        </div>

    </div>

{% endfor %}

